---
title: è¯¾è¡¨åŠ©æ‰‹
date: 2020-03-13 14:12:48
updated: 2020-03-13 14:12:48
tags: 
- Javascript
- è¯¾ç¨‹è¡¨
- iCalendar
categories:
- [å°å·¥å…·]
- [å¼€å‘è¿‡ç¨‹åˆ†äº«]
---

## ç®€è¦ä»‹ç»

ä½œè€…æ˜¯ä¸€åå­¦ç”Ÿï¼Œéœ€è¦åœ¨æ‰‹æœºä¸Šè®°å½•è¯¾è¡¨ï¼Œè™½ç„¶ç°åœ¨å·²ç»æœ‰å¾ˆå¤šçš„è¯¾ç¨‹è¡¨Appäº†ï¼Œä½†æ˜¯æœ‰äº›å‘¢ä¸æ”¯æŒä»æ•™åŠ¡ç³»ç»Ÿå¯¼å…¥ï¼Œæœ‰äº›å‘¢ä¼šæœ‰å¾ˆå¤šå¹¿å‘Šï¼Œå†æœ‰äº›å°±æ˜¯ç•Œé¢å¾ˆä¸‘å•¦~

å› æ­¤ï¼Œä¸ºäº†èƒ½å¤Ÿä¾¿æ·çš„æŸ¥çœ‹è¯¾è¡¨ï¼Œå…å»ç°æœ‰çš„è¯¾ç¨‹è¡¨è½¯ä»¶å¸¦æ¥çš„çƒ¦æ¼ï¼Œæˆ‘å†³å®šï¼å¼€å‘ä¸€æ¬¾æ— å®³çš„è¯¾è¡¨è½¯ä»¶ã€‚äºæ˜¯ï¼Œè¿™æ¬¾â€œè¯¾è¡¨åŠ©æ‰‹â€å°±åº”è¿è€Œç”Ÿï¼ˆè™½ç„¶ä¸æ˜¯ä¸€ä¸ªAppï¼Œåé¢å†è¯¦ç»†è§£é‡Šï¼‰ï¼Œå®ƒçš„ä½œç”¨ä¸æ˜¯æ˜¾ç¤ºè¯¾è¡¨ï¼Œè€Œæ˜¯å°†æ•™åŠ¡ç³»ç»Ÿä¸­çš„è¯¾è¡¨è½¬ä¸º[iCalendar](https://zh.wikipedia.org/wiki/ICalendar)æ–‡ä»¶ã€‚iCalendaræ˜¯ä¸€ç§æ—¥å†æ•°æ®äº¤æ¢çš„æ ‡å‡†ï¼Œæ—¢ç„¶æ˜¯æ ‡å‡†äº†ï¼Œé‚£å¤§å®¶è‚¯å®šéƒ½æ”¯æŒå•¦ï¼Œç›®å‰å·²ç»æµ‹è¯•äº†Win10/Android9/iPadOS13ï¼Œéƒ½å¯ä»¥å¯¼å…¥è‡³æ—¥å†ã€‚å¯¼å…¥åå°±å¯ä»¥æ„‰å¿«çš„ä½¿ç”¨ç³»ç»Ÿæ—¥å†æŸ¥çœ‹è¯¾è¡¨äº†ï¼Œä¸å¾—ä¸è¯´ï¼Œç³»ç»Ÿè‡ªå¸¦çš„æ—¥å†ç•Œé¢æ¸…æ–°ã€ä½¿ç”¨æµç•…ã€æ²¡æœ‰å¹¿å‘Šï¼ˆç”¨è¿‡çš„éƒ½è¯´å¥½ğŸ™„ï¼‰ã€‚

- è„šæœ¬å®‰è£…è¯·æŸ¥çœ‹[Greasyfork](https://greasyfork.org/zh-CN/scripts/397788-%E8%AF%BE%E8%A1%A8%E5%8A%A9%E6%89%8B)
- å®Œæ•´æºç è¯·æŸ¥çœ‹[Github](https://github.com/chaiqingao/Curriculum-to-iCalendar)

<!-- more -->

## å¼€å‘è¿‡ç¨‹

### å‡†å¤‡å·¥ä½œ

ä¸ºäº†æ˜ç¡®æˆ‘è¦åšä»€ä¹ˆï¼Œé¦–å…ˆæ‰“å¼€äº†æ•™åŠ¡ç³»ç»Ÿè¯¾ç¨‹è¡¨é¡µé¢ï¼Œä»–æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š
![æ•™åŠ¡ç³»ç»Ÿ](https://s1.ax1x.com/2020/03/13/8uc7a8.png)
çœ‹äº†ä¸€ä¸‹ï¼Œå—¯ï¼æŒºå¥½çš„ï¼Œé€‚åˆåºåˆ—åŒ–ã€‚ç„¶åå†çœ‹ä¸€ä¸‹iCalendaræ–‡ä»¶çš„æ ·å­ï¼š

``` bash
BEGIN:VCALENDAR
VERSION:2.0
PRODID:Curriculum-to-iCalendar
BEGIN:VEVENT
DTSTAMP:20200313T032000Z
UID:0@https://chaiqingao.github.io/
SUMMARY:summary
DTSTART:20200217T000000Z
DTEND:20200217T013500Z
RRULE:FREQ=WEEKLY;UNTIL=20200428T013500Z;INTERVAL=1
LOCATION:location
DESCRIPTION:description
END:VEVENT
BEGIN:VEVENT
......
END:VEVENT
END:VCALENDAR
```

ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ªiCalendaræ–‡ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šå¤´ + \[VENVENTæ•°ç»„\] + å°¾ã€‚æ¯ä¸€ä¸ª`VENVENT`æœ‰`DTSTAMP`åˆ›å»ºçš„æ—¶é—´ã€`UID`æ ‡è¯†ç¬¦ã€`SUMMARY`äº‹ä»¶åã€`DTSTART`äº‹ä»¶å¼€å§‹æ—¶é—´ã€`DTEND`äº‹ä»¶ç»“æŸæ—¶é—´ã€`RRULE`é‡å¤æ–¹å¼ï¼ˆåŒ…æ‹¬`FREQ`é¢‘ç‡ã€`UNTIL`é‡å¤æˆªè‡³æ—¶é—´ã€`INTERVAL`é—´éš”ï¼‰ã€`LOCATION`åœ°ç‚¹ã€`DESCRIPTION`è¯¦ç»†ä¿¡æ¯ã€‚æŒæ¡äº†è¿™äº›ä¸œè¥¿ï¼Œä¸‹é¢å°±å¼€å§‹å§ï¼

### å®šä½è‡³æ•™åŠ¡ç³»ç»Ÿä¸­çš„è¯¾ç¨‹è¡¨

æŸ¥çœ‹ç½‘é¡µæºç ï¼Œå¯ä»¥å‘ç°ï¼Œæ•™åŠ¡ç³»ç»Ÿçš„è¯¾ç¨‹è¡¨åµŒå¥—åœ¨ä¸¤å±‚iframeï¼ˆ`top->page_iframe->iframe0`ï¼‰ä¸­ï¼Œç»è¿‡ä¸€ç•ªåŠªåŠ›ï¼Œå®šä½åˆ°äº†ï¼

```Javascript
var page_iframe = document.getElementById("page_iframe");
var iframe0 = page_iframe.contentDocument.getElementById("iframe0");
var table = iframe0.contentDocument.getElementsByTagName("table")[0];
```

ä¸‹é¢å°±å¯ä»¥å¯¹è¡¨æ ¼é‡Œçš„å†…å®¹~~ä¸ºæ‰€æ¬²ä¸º~~è¿›è¡Œæ“ä½œäº†ã€‚

### è·å–è¡¨æ ¼ä¸­è¯¾ç¨‹åå’Œä¸Šè¯¾æ—¶é—´éç©ºçš„è¡Œ

ç¬¬ä¸€è¦äº‹ï¼ç¡®ä¿è¿™ä¸ªè¯¾æ˜¯å­˜åœ¨çš„ï¼Œè¿™ä¸ªç®€å•ä¸€ç‚¹ï¼š

```Javascript
for (let i = 1; i < table.rows.length; i++) {
    var courseName = table.rows[i].cells[1].innerText;
    var teacherName = table.rows[i].cells[5].innerText;
    var timeAddress = table.rows[i].cells[9].innerText;
    if (courseName !== "" && timeAddress !== "") {
        ...
    }
}
```

### æ„å»º`VEVENT`

`courseName`å°±ä½œä¸º`SUMMARY`å§ï¼Œä¸‹é¢æ˜¯å¯¹`timeAddress`çš„è§£æï¼Œä»ä¸­æå–å‡ºæ—¥æœŸæ—¶é—´åœ°å€

```Javascript
var toString = function (date) {
    return date.toISOString().split(/-|:|[.]/).slice(0, 4).join("") + "00Z";
}
var events = timeAddress.split(' ').filter(n => n != "");
for (let j = 0; j < events.length; j++) {
    //å‘¨ä¸€:1-11å‘¨,æ¯1å‘¨;1-2èŠ‚,3åŒº,é™„3-401 ==> [ä¸€,1-11,1,1-2,3åŒº,é™„3-401]
    var informations = events[j].split(/å‘¨,æ¯|å‘¨|èŠ‚,|:|,|;/).filter(n => n != "");
    var description = "ç¬¬" + events[j].split(";")[1] + " " + teacherName;
    var weekDay = weekToNum[informations[0]];
    var startWeek = parseInt(informations[1].split("-")[0]);
    var endWeek = parseInt(informations[1].split("-")[1]);
    var interval = parseInt(informations[2]);
    var startTime = class_start[parseInt(informations[3].split('-')[0])];
    var endTime = class_start[parseInt(informations[3].split('-')[1])];
    var address = [informations[4], informations[5], teacherName].join(" ");
    var startDate = new Date(),endDate=new Date(),untilDate=new Date();
    startDate.setDate(startDate.getDate() - startDate.getDay() - (currentWeek - startWeek) * 7 + weekDay);
    startDate.setHours(startTime[0], startTime[1], 0, 0);
    endDate.setDate(endDate.getDate() - endDate.getDay() - (currentWeek - startWeek) * 7 + weekDay);
    endDate.setHours(endTime[0],endTime[1]+class_time);
    untilDate.setDate(untilDate.getDate() - untilDate.getDay() + (endWeek - currentWeek) * 7 + weekDay + 1);
    untilDate.setHours(endTime[0],endTime[1]+class_time);
    calendarEvents.push([
        'BEGIN:VEVENT',
        'DTSTAMP:' + toString(new Date()),
        'UID:' + calendarEvents.length + '@' + 'https://chaiqingao.github.io/',
        'SUMMARY:' + courseName,
        'DTSTART:' + toString(startDate),
        'DTEND:' + toString(endDate),
        'RRULE:FREQ=WEEKLY;UNTIL=' + toString(untilDate) + ';INTERVAL=' + interval,
        'LOCATION:' + address,
        'DESCRIPTION:' + description,
        'END:VEVENT'
    ].join(SEPARATOR));
}
```

è¿™é‡Œçš„`calendarEvents`æ˜¯ä¸€ä¸ªäº‹ä»¶æ•°ç»„ï¼Œé‡Œé¢å­˜å‚¨äº†æ‰€æœ‰çš„è¯¾ç¨‹ï¼ŒåŠ ä¸Šå¤´å°¾å°±å¯ä»¥ä¿å­˜äº†ğŸ˜

### ä¿å­˜æ–‡ä»¶

è¿™é‡Œä½¿ç”¨äº†`FileSaver.js`ç”¨äºä¿å­˜æ–‡ä»¶

```Javascript
var fileName = year + "å­¦å¹´ç¬¬" + term + "å­¦æœŸ.ics";
var calendar = calendar_start + SEPARATOR + calendarEvents.join(SEPARATOR) + calendar_end;
var blob;
if (navigator.userAgent.indexOf('MSIE 10') === -1) { // chrome or firefox
    blob = new Blob([calendar]);
} else { // ie
    var bb = new BlobBuilder();
    bb.append(calendar);
    blob = bb.getBlob('text/x-vCalendar;charset=' + document.characterSet);
}
```

## ç»“æœå±•ç¤º

è¿™é‡Œå°†icsæ–‡ä»¶å¯¼å…¥è‡³ç™»å½•äº†Outlooké‚®ç®±çš„Win10æ—¥å†ï¼Œè¿˜æ˜¯å¾ˆä¸é”™çš„å˜›ğŸ˜œ~
![Win10æ—¥å†](https://s1.ax1x.com/2020/03/13/8uT8Nn.png)
å†æ‰“å¼€iPadOSæ—¥å†çœ‹çœ‹ï¼Œå·²ç»åŒæ­¥äº†ğŸ‘~ï¼ˆå‰ææ˜¯ç™»å½•ç›¸åŒçš„é‚®ç®±ï¼‰
![iPadOSæ—¥å†](https://s1.ax1x.com/2020/03/13/8uTbgf.jpg)
å°±å‰©Androidå’¯ï¼Œæ‰“å¼€ä¸€çœ‹å‘ç°å¹¶æ²¡æœ‰åŒæ­¥ğŸ˜¥ï¼Œåˆå»æœäº†ä¸€äº›æ•™ç¨‹ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¾ˆå¥½çš„è§£å†³æ–¹æ³•ï¼Œåªå¥½æŠŠicsæ–‡ä»¶å‘é€è‡³æ‰‹æœºç„¶åæ‰‹åŠ¨æ‰“å¼€äº†ã€‚
![Androidæ—¥å†](https://s1.ax1x.com/2020/03/13/8uT7Ct.jpg)

## è„šæœ¬ä¸‹è½½åœ°å€

å°†ä»¥ä¸Šå†…å®¹åšæˆäº†æ²¹çŒ´åŠ©æ‰‹è„šæœ¬å¹¶ä¸Šä¼ è‡³äº†greasyforkï¼Œå…³äºæ²¹çŒ´åŠ©æ‰‹è¯·ç‚¹[è¿™é‡Œ](https://www.tampermonkey.net/)ï¼Œä¸‹è½½è„šæœ¬è¯·ç‚¹[è¿™é‡Œ](https://greasyfork.org/zh-CN/scripts/397788-%E8%AF%BE%E8%A1%A8%E5%8A%A9%E6%89%8B)

ğŸ’«è„šæœ¬ç‰¹ç‚¹ï¼šä¸€é”®ä¿å­˜icsæ–‡ä»¶ï¼Œæ–¹ä¾¿å¿«æ·

## Githubé¡¹ç›®åœ°å€

åƒå±±ä¸‡æ°´æ€»æ˜¯æƒ…ï¼Œç»™ä¸ªStarè¡Œä¸è¡Œ [Curriculum-to-iCalendar](https://github.com/chaiqingao/Curriculum-to-iCalendar)

## ç›®å‰æ”¯æŒçš„æ•™åŠ¡ç³»ç»Ÿ

- WHU

## æ€»ç»“

ç¬¬ä¸€æ¬¡å†™è¿™ç§æ²¹çŒ´åŠ©æ‰‹çš„è„šæœ¬ï¼Œä¹Ÿç®—æ˜¯ç»ƒä¹ äº†Javascriptçš„åº”ç”¨å§ï¼Œè¿‡ç¨‹ç£•ç£•ç»Šç»Šçš„ï¼Œä»æœ‰è¿™ä¸ªæƒ³æ³•åˆ°å®ç°ç»å†äº†ä¸¤å¤©æ—¶é—´ï¼Œæ‰¾æœ‹å‹æµ‹è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°äº†å¾ˆå¤šğŸ›bug......ä¿®æ”¹å†æµ‹è¯•ï¼Œæµ‹è¯•å†ä¿®æ”¹ï¼Œåˆ°ç°åœ¨è¿˜ç®—æ˜¯æŒºå®Œå–„çš„ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶åœ¨GithubæIssueã€‚
